# 01 项目目标与边界

## 1. 项目目的

`comfy_env` 要解决 ComfyUI 插件生态中常见的依赖失控问题：

1. 插件安装/更新导致核心依赖被意外升级或降级。
2. 依赖漂移不可追踪，问题出现后无法定位来源。
3. 卸载插件时依赖清理不彻底，环境逐步污染。
4. 失败后缺少可靠回滚路径。

## 2. 核心目标

1. 可复现：给定 `pyproject.toml + uv.lock` 可重建环境。
2. 可回滚：通过 snapshot 恢复依赖真相与插件注册状态。
3. 可审计：每次事务保留前后差异、日志、状态。
4. 可治理：核心包变更默认门禁，冲突需显式处理。

## 3. 非目标

1. 不修改 ComfyUI 源码。
2. 不托管系统层依赖（CUDA 驱动、编译工具链等）。
3. 不承诺完整治理插件的非 Python 副作用（文件下载、系统调用等）。

## 4. 设计原则

1. 先隔离再晋升：先在 Candidate 环境观察副作用，再决定是否进入 Prod。
2. 真相最小化：只有声明真相和插件注册属于回滚范围。
3. 失败优先恢复：任何关键流程失败都以恢复到前置 snapshot 为首要动作。
4. 对核心包保守：核心包变更默认阻断，需人工批准。

## 5. 成功标准

1. 任意时刻可通过 `rollback` 回到稳定状态。
2. Promote 冲突能够结构化报告并可交互修复。
3. 节点卸载后可完成依赖 GC，且共享依赖不误删。
